# ğŸ—ï¸ GameLink åŸºç¡€è®¾æ–½è¯„ä¼°æŠ¥å‘Š

ç”Ÿæˆæ—¶é—´: 2025-11-10

## ğŸ“Š å½“å‰åŸºç¡€è®¾æ–½çŠ¶æ€

### 1. æ•°æ®æ¨¡å‹å±‚ (Model)

#### âœ… å·²å®Œæˆçš„æ¨¡å‹
- **ç”¨æˆ·ç³»ç»Ÿ**: User, UserRole
- **é™ªç©å¸ˆç³»ç»Ÿ**: Player, PlayerGame, PlayerSkillTag, PlayerRelation
- **è®¢å•ç³»ç»Ÿ**: Order, Payment, Review
- **æ¸¸æˆç³»ç»Ÿ**: Game
- **æœåŠ¡é¡¹ç›®**: ServiceItem (ç»Ÿä¸€ç®¡ç†æŠ¤èˆªæœåŠ¡å’Œç¤¼ç‰©)
- **è´¢åŠ¡ç³»ç»Ÿ**: Withdraw, Commission (CommissionRule, CommissionRecord, MonthlySettlement)
- **æ’è¡Œæ¦œç³»ç»Ÿ**: PlayerRanking, RankingCommissionConfig
- **æƒé™ç³»ç»Ÿ**: Permission, RoleModel, RolePermission, UserRole
- **æ“ä½œæ—¥å¿—**: OperationLog
- **ç¤¾äº¤ç³»ç»Ÿ**: Follow, Favorite, Gift, GiftRecord

#### âš ï¸ éœ€è¦å®Œå–„çš„æ¨¡å‹

##### 1.1 ä¼šå‘˜è®¢é˜…ç³»ç»Ÿ (Phase 3 éœ€è¦)
```sql
-- ç¼ºå¤±çš„è¡¨
âŒ membership_tiers (ä¼šå‘˜ç­‰çº§è¡¨)
âŒ memberships (ä¼šå‘˜è®¢é˜…è¡¨)
âŒ membership_benefits (ä¼šå‘˜æƒç›Šè¡¨)
```

##### 1.2 å®æ—¶èŠå¤©ç³»ç»Ÿ (Phase 4 éœ€è¦)
```sql
-- ç¼ºå¤±çš„è¡¨
âŒ chat_messages (èŠå¤©æ¶ˆæ¯è¡¨)
âŒ conversations (ä¼šè¯è¡¨)
```

##### 1.3 è¥é”€å·¥å…·ç³»ç»Ÿ (Phase 5 éœ€è¦)
```sql
-- ç¼ºå¤±çš„è¡¨
âŒ coupon_templates (ä¼˜æƒ åˆ¸æ¨¡æ¿è¡¨)
âŒ user_coupons (ç”¨æˆ·ä¼˜æƒ åˆ¸è¡¨)
âŒ marketing_campaigns (è¥é”€æ´»åŠ¨è¡¨)
âŒ campaign_participations (æ´»åŠ¨å‚ä¸è®°å½•è¡¨)
âŒ notification_templates (é€šçŸ¥æ¨¡æ¿è¡¨)
âŒ notifications (é€šçŸ¥è®°å½•è¡¨)
```

##### 1.4 æ–‡ä»¶ä¸Šä¼ ç³»ç»Ÿ (Phase 2 éœ€è¦)
```sql
-- ç¼ºå¤±çš„è¡¨
âŒ uploads (æ–‡ä»¶ä¸Šä¼ è®°å½•è¡¨)
```

### 2. æ•°æ®åº“è¿ç§» (Migration)

#### âœ… å·²å®Œæˆ
- âœ… AutoMigrate æœºåˆ¶å®Œå–„
- âœ… å­—æ®µè¿ç§»å¤„ç† (prepareOrdersMigration)
- âœ… æ•°æ®ä¿®å¤ (runDataFixups)
- âœ… ç´¢å¼•ä¼˜åŒ– (ensureIndexes)
- âœ… é»˜è®¤è§’è‰²åˆ›å»º (ensureDefaultRoles)
- âœ… è¶…çº§ç®¡ç†å‘˜åˆ›å»º (ensureSuperAdmin)
- âœ… é»˜è®¤æŠ½æˆè§„åˆ™åˆ›å»º (ensureDefaultCommissionRule)
- âœ… è®¢å•å·ç”Ÿæˆ (generateOrderNumbers)

#### âš ï¸ éœ€è¦å®Œå–„
- âš ï¸ ç¼ºå°‘ç‰ˆæœ¬åŒ–è¿ç§»ç³»ç»Ÿ (å»ºè®®ä½¿ç”¨ golang-migrate)
- âš ï¸ ç¼ºå°‘å›æ»šæœºåˆ¶
- âš ï¸ ç¼ºå°‘è¿ç§»å†å²è®°å½•

### 3. ä¸­é—´ä»¶ç³»ç»Ÿ (Middleware)

#### âœ… å·²å®Œæˆ
- âœ… è®¤è¯ä¸­é—´ä»¶ (auth.go, jwt_auth.go)
- âœ… CORS ä¸­é—´ä»¶ (cors.go)
- âœ… åŠ å¯†ä¸­é—´ä»¶ (crypto.go)
- âœ… é”™è¯¯æ˜ å°„ (error_map.go)
- âœ… æŒ‡æ ‡æ”¶é›† (metrics.go)
- âœ… æƒé™æ§åˆ¶ (permission.go)
- âœ… é™æµä¸­é—´ä»¶ (rate_limit.go) âš ï¸ éœ€è¦å¢å¼º
- âœ… æ¢å¤ä¸­é—´ä»¶ (recovery.go)
- âœ… è¯·æ±‚ID (request_id.go)
- âœ… éªŒè¯ä¸­é—´ä»¶ (validation.go)

#### âŒ ç¼ºå¤±çš„ä¸­é—´ä»¶
- âŒ CSRF ä¿æŠ¤ä¸­é—´ä»¶
- âŒ æ–‡ä»¶ä¸Šä¼ ä¸­é—´ä»¶
- âŒ è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶ (ç»“æ„åŒ–æ—¥å¿—)
- âŒ å®‰å…¨å¤´ä¸­é—´ä»¶ (X-Frame-Options, CSPç­‰)

### 4. ç¼“å­˜ç³»ç»Ÿ (Cache)

#### âœ… å·²å®Œæˆ
- âœ… Cache æ¥å£å®šä¹‰
- âœ… å†…å­˜ç¼“å­˜å®ç° (memory_test.go æ˜¾ç¤ºæœ‰æµ‹è¯•)

#### âš ï¸ éœ€è¦å®Œå–„
- âš ï¸ Redis ç¼“å­˜å®ç°
- âš ï¸ å¤šçº§ç¼“å­˜ç­–ç•¥
- âš ï¸ ç¼“å­˜é¢„çƒ­æœºåˆ¶
- âš ï¸ ç¼“å­˜ç©¿é€/é›ªå´©é˜²æŠ¤
- âš ï¸ ç¼“å­˜æ›´æ–°ç­–ç•¥

### 5. é…ç½®ç®¡ç† (Config)

#### âœ… å·²å®Œæˆ
- âœ… ç¯å¢ƒå˜é‡åŠ è½½
- âœ… é…ç½®ç»“æ„å®šä¹‰
- âœ… SuperAdmin é…ç½®

#### âš ï¸ éœ€è¦å®Œå–„
- âš ï¸ é…ç½®éªŒè¯
- âš ï¸ é…ç½®çƒ­æ›´æ–°
- âš ï¸ å¤šç¯å¢ƒé…ç½®ç®¡ç†

### 6. é”™è¯¯å¤„ç† (Error)

#### âœ… å·²å®Œæˆ
- âœ… API é”™è¯¯å®šä¹‰ (apierr)
- âœ… é”™è¯¯æ¶ˆæ¯å›½é™…åŒ–

#### âš ï¸ éœ€è¦å®Œå–„
- âš ï¸ é”™è¯¯ç æ ‡å‡†åŒ–
- âš ï¸ é”™è¯¯å †æ ˆè¿½è¸ª
- âš ï¸ é”™è¯¯èšåˆå’ŒæŠ¥è­¦

### 7. æ—¥å¿—ç³»ç»Ÿ (Logging)

#### âœ… å·²å®Œæˆ
- âœ… åŸºç¡€æ—¥å¿—å®ç°

#### âš ï¸ éœ€è¦å®Œå–„
- âš ï¸ ç»“æ„åŒ–æ—¥å¿—
- âš ï¸ æ—¥å¿—çº§åˆ«æ§åˆ¶
- âš ï¸ æ—¥å¿—è½®è½¬
- âš ï¸ æ—¥å¿—èšåˆ (ELK/Loki)

### 8. ç›‘æ§ç³»ç»Ÿ (Metrics)

#### âœ… å·²å®Œæˆ
- âœ… åŸºç¡€æŒ‡æ ‡æ”¶é›†

#### âš ï¸ éœ€è¦å®Œå–„
- âš ï¸ Prometheus é›†æˆ
- âš ï¸ ä¸šåŠ¡æŒ‡æ ‡å®šä¹‰
- âš ï¸ å‘Šè­¦è§„åˆ™é…ç½®
- âš ï¸ Grafana ä»ªè¡¨æ¿

---

## ğŸ¯ ä¼˜å…ˆçº§æ”¹è¿›è®¡åˆ’

### ğŸ”¥ P0 - ç«‹å³å®Œæˆ (æœ¬å‘¨)

#### 1. å®Œå–„ CSRF ä¿æŠ¤
**æ–‡ä»¶**: `internal/handler/middleware/csrf.go`
```go
// éœ€è¦å®ç°
- CSRF Token ç”Ÿæˆ
- CSRF éªŒè¯ä¸­é—´ä»¶
- Cookie å®‰å…¨é…ç½®
```

#### 2. å¢å¼ºé™æµä¸­é—´ä»¶
**æ–‡ä»¶**: `internal/handler/middleware/rate_limit.go`
```go
// å½“å‰çŠ¶æ€: åŸºç¡€å®ç°
// éœ€è¦å¢å¼º:
- æ»‘åŠ¨çª—å£ç®—æ³•
- Redis å­˜å‚¨æ”¯æŒ
- åˆ†å¸ƒå¼é™æµ
- è‡ªå®šä¹‰é™æµè§„åˆ™
```

#### 3. æ–‡ä»¶ä¸Šä¼ å®‰å…¨
**æ–°æ–‡ä»¶**: `internal/handler/middleware/upload.go`
```go
// éœ€è¦å®ç°
- æ–‡ä»¶ç±»å‹ç™½åå•éªŒè¯
- æ–‡ä»¶å¤§å°é™åˆ¶
- æ–‡ä»¶åéšæœºåŒ–
- ç—…æ¯’æ‰«æé›†æˆ (å¯é€‰)
```

**æ–°æ¨¡å‹**: `internal/model/upload.go`
```go
type Upload struct {
    BaseModel
    UserID     uint64
    FileName   string
    FilePath   string
    FileSize   int64
    MimeType   string
    UploadType string // avatar, certification, etc
    Status     string
}
```

#### 4. å®‰å…¨å¤´ä¸­é—´ä»¶
**æ–°æ–‡ä»¶**: `internal/handler/middleware/security_headers.go`
```go
// éœ€è¦å®ç°
- X-Frame-Options
- X-Content-Type-Options
- X-XSS-Protection
- Content-Security-Policy
- Strict-Transport-Security
```

---

### ğŸŸ¡ P1 - é«˜ä¼˜å…ˆçº§ (ä¸‹å‘¨)

#### 5. Redis ç¼“å­˜å®ç°
**æ–°æ–‡ä»¶**: `internal/cache/redis.go`
```go
// éœ€è¦å®ç°
- Redis å®¢æˆ·ç«¯å°è£…
- ç¼“å­˜ç­–ç•¥å®šä¹‰
- ç¼“å­˜é¢„çƒ­
- ç¼“å­˜å¤±æ•ˆç­–ç•¥
```

#### 6. ç»“æ„åŒ–æ—¥å¿—
**æ–‡ä»¶**: `internal/logging/logger.go`
```go
// éœ€è¦å¢å¼º
- ä½¿ç”¨ slog æˆ– zap
- æ—¥å¿—çº§åˆ«æ§åˆ¶
- æ—¥å¿—æ ¼å¼åŒ–
- æ—¥å¿—ä¸Šä¸‹æ–‡
```

#### 7. é…ç½®éªŒè¯
**æ–‡ä»¶**: `internal/config/env.go`
```go
// éœ€è¦å¢å¼º
- é…ç½®å­—æ®µéªŒè¯
- å¿…å¡«é¡¹æ£€æŸ¥
- é»˜è®¤å€¼è®¾ç½®
- é…ç½®æ–‡æ¡£ç”Ÿæˆ
```

---

### ğŸŸ¢ P2 - ä¸­ä¼˜å…ˆçº§ (2å‘¨å†…)

#### 8. ç‰ˆæœ¬åŒ–è¿ç§»ç³»ç»Ÿ
**å»ºè®®**: é›†æˆ `golang-migrate/migrate`
```bash
# è¿ç§»æ–‡ä»¶ç¤ºä¾‹
migrations/
  000001_init_schema.up.sql
  000001_init_schema.down.sql
  000002_add_membership_tables.up.sql
  000002_add_membership_tables.down.sql
```

#### 9. Prometheus ç›‘æ§é›†æˆ
**æ–°æ–‡ä»¶**: `internal/metrics/prometheus.go`
```go
// éœ€è¦å®ç°
- HTTP è¯·æ±‚æŒ‡æ ‡
- æ•°æ®åº“è¿æ¥æ± æŒ‡æ ‡
- ç¼“å­˜å‘½ä¸­ç‡æŒ‡æ ‡
- ä¸šåŠ¡æŒ‡æ ‡ (è®¢å•é‡ã€æ”¯ä»˜æˆåŠŸç‡ç­‰)
```

#### 10. é”™è¯¯è¿½è¸ªç³»ç»Ÿ
**å»ºè®®**: é›†æˆ Sentry æˆ–è‡ªå»º
```go
// éœ€è¦å®ç°
- é”™è¯¯æ•è·
- é”™è¯¯èšåˆ
- é”™è¯¯å‘Šè­¦
- é”™è¯¯åˆ†æ
```

---

## ğŸ“‹ æ–°å¢æ•°æ®æ¨¡å‹æ¸…å•

### Phase 2: å®‰å…¨å¢å¼º

#### Upload Model
```go
// internal/model/upload.go
type Upload struct {
    BaseModel
    UserID      uint64 `gorm:"not null;index:idx_uploads_user"`
    FileName    string `gorm:"size:255;not null"`
    FilePath    string `gorm:"size:500;not null"`
    FileSize    int64  `gorm:"not null"`
    MimeType    string `gorm:"size:100;not null"`
    UploadType  string `gorm:"size:50;not null;index:idx_uploads_type"`
    Status      string `gorm:"size:20;default:'pending'"`
    Hash        string `gorm:"size:64;index:idx_uploads_hash"` // æ–‡ä»¶å“ˆå¸Œï¼Œç”¨äºå»é‡
}
```

### Phase 3: ä¼šå‘˜è®¢é˜…ç³»ç»Ÿ

#### MembershipTier Model
```go
// internal/model/membership.go
type MembershipTier struct {
    BaseModel
    Name         string `gorm:"size:50;not null"`
    Type         string `gorm:"size:20;not null"` // user_vip, player_certified
    PriceCents   int    `gorm:"not null"`
    DurationDays int    `gorm:"not null"`
    Benefits     string `gorm:"type:text"` // JSON
    SortOrder    int    `gorm:"default:0"`
    IsActive     bool   `gorm:"default:true"`
}

type Membership struct {
    BaseModel
    UserID        uint64    `gorm:"not null;index:idx_memberships_user"`
    TierID        uint64    `gorm:"not null"`
    StartDate     time.Time `gorm:"not null"`
    EndDate       time.Time `gorm:"not null;index:idx_memberships_end"`
    Status        string    `gorm:"size:20;default:'active';index:idx_memberships_status"`
    AutoRenew     bool      `gorm:"default:false"`
    PaymentMethod string    `gorm:"size:50"`
}
```

### Phase 4: å®æ—¶èŠå¤©

#### ChatMessage Model
```go
// internal/model/chat.go
type Conversation struct {
    BaseModel
    OrderID        *uint64    `gorm:"index:idx_conversations_order"`
    UserID         uint64     `gorm:"not null;index:idx_conversations_user"`
    PlayerID       uint64     `gorm:"not null;index:idx_conversations_player"`
    LastMessage    string     `gorm:"type:text"`
    LastMessageAt  *time.Time
    UnreadCount    int    `gorm:"default:0"`
    Status         string `gorm:"size:20;default:'active'"`
}

type ChatMessage struct {
    BaseModel
    ConversationID uint64 `gorm:"not null;index:idx_messages_conversation"`
    SenderID       uint64 `gorm:"not null;index:idx_messages_sender"`
    ReceiverID     uint64 `gorm:"not null;index:idx_messages_receiver"`
    MessageType    string `gorm:"size:20;default:'text'"` // text, image, voice
    Content        string `gorm:"type:text;not null"`
    IsRead         bool   `gorm:"default:false"`
}
```

### Phase 5: è¥é”€å·¥å…·

#### Coupon Models
```go
// internal/model/coupon.go
type CouponTemplate struct {
    BaseModel
    Name               string     `gorm:"size:100;not null"`
    Type               string     `gorm:"size:20;not null"` // discount, cashback, gift
    DiscountType       string     `gorm:"size:20"`          // percentage, fixed
    DiscountValue      int        `gorm:"not null"`
    MinOrderAmount     int        `gorm:"default:0"`
    MaxDiscountAmount  *int
    TotalQuantity      int        `gorm:"not null"`
    RemainingQuantity  int        `gorm:"not null"`
    ValidFrom          time.Time  `gorm:"not null;index:idx_coupons_valid"`
    ValidTo            time.Time  `gorm:"not null;index:idx_coupons_valid"`
    ApplicableGames    string     `gorm:"type:text"` // JSON
    ApplicablePlayers  string     `gorm:"type:text"` // JSON
    Status             string     `gorm:"size:20;default:'active';index:idx_coupons_status"`
}

type UserCoupon struct {
    BaseModel
    UserID     uint64     `gorm:"not null;index:idx_user_coupons_user"`
    TemplateID uint64     `gorm:"not null"`
    CouponCode string     `gorm:"size:50;unique;not null;index:idx_user_coupons_code"`
    Status     string     `gorm:"size:20;default:'unused';index:idx_user_coupons_status"`
    UsedAt     *time.Time
    OrderID    *uint64
}
```

#### Campaign Models
```go
// internal/model/campaign.go
type MarketingCampaign struct {
    BaseModel
    Name        string    `gorm:"size:100;not null"`
    Type        string    `gorm:"size:50;not null;index:idx_campaigns_type"` // new_user, recharge, invite
    Description string    `gorm:"type:text"`
    Rules       string    `gorm:"type:text;not null"` // JSON
    Rewards     string    `gorm:"type:text;not null"` // JSON
    StartTime   time.Time `gorm:"not null;index:idx_campaigns_time"`
    EndTime     time.Time `gorm:"not null;index:idx_campaigns_time"`
    Status      string    `gorm:"size:20;default:'draft';index:idx_campaigns_status"`
    CreatedBy   uint64    `gorm:"not null"`
}

type CampaignParticipation struct {
    BaseModel
    CampaignID  uint64     `gorm:"not null;index:idx_participations_campaign"`
    UserID      uint64     `gorm:"not null;index:idx_participations_user"`
    RewardType  string     `gorm:"size:50"`
    RewardValue string     `gorm:"size:200"`
    Status      string     `gorm:"size:20;default:'pending'"`
    CompletedAt *time.Time
}
```

#### Notification Models
```go
// internal/model/notification.go
type NotificationTemplate struct {
    BaseModel
    Name      string `gorm:"size:100;not null"`
    Type      string `gorm:"size:50;not null"` // order, payment, system
    Title     string `gorm:"size:200;not null"`
    Content   string `gorm:"type:text;not null"`
    Variables string `gorm:"type:text"` // JSON
    Channels  string `gorm:"type:text"` // JSON: push, sms, email
}

type Notification struct {
    BaseModel
    UserID     uint64     `gorm:"not null;index:idx_notifications_user"`
    TemplateID *uint64
    Title      string     `gorm:"size:200;not null"`
    Content    string     `gorm:"type:text;not null"`
    Type       string     `gorm:"size:50;not null;index:idx_notifications_type"`
    Channel    string     `gorm:"size:20;not null"`
    Status     string     `gorm:"size:20;default:'pending';index:idx_notifications_status"`
    SentAt     *time.Time
    ReadAt     *time.Time
}
```

---

## ğŸš€ ç«‹å³è¡ŒåŠ¨é¡¹

### æœ¬å‘¨ä»»åŠ¡ (Week 1)

#### Day 1-2: CSRF å’Œå®‰å…¨å¤´
- [ ] åˆ›å»º `csrf.go` ä¸­é—´ä»¶
- [ ] åˆ›å»º `security_headers.go` ä¸­é—´ä»¶
- [ ] ç¼–å†™æµ‹è¯•ç”¨ä¾‹
- [ ] é›†æˆåˆ°è·¯ç”±

#### Day 3-4: æ–‡ä»¶ä¸Šä¼ 
- [ ] åˆ›å»º `Upload` æ¨¡å‹
- [ ] åˆ›å»º `upload.go` ä¸­é—´ä»¶
- [ ] å®ç°æ–‡ä»¶éªŒè¯é€»è¾‘
- [ ] é›†æˆ OSS (é˜¿é‡Œäº‘/ä¸ƒç‰›)
- [ ] ç¼–å†™æµ‹è¯•ç”¨ä¾‹

#### Day 5-6: é™æµå¢å¼º
- [ ] å¢å¼º `rate_limit.go`
- [ ] å®ç°æ»‘åŠ¨çª—å£ç®—æ³•
- [ ] Redis å­˜å‚¨æ”¯æŒ
- [ ] ç¼–å†™æµ‹è¯•ç”¨ä¾‹

#### Day 7: Redis ç¼“å­˜
- [ ] åˆ›å»º `redis.go` å®ç°
- [ ] å®šä¹‰ç¼“å­˜ç­–ç•¥
- [ ] ç¼–å†™æµ‹è¯•ç”¨ä¾‹

---

## ğŸ“Š å®Œæˆæ ‡å‡†

### Phase 2 å®Œæˆæ ‡å‡†
- [ ] CSRF ä¿æŠ¤æ­£å¸¸å·¥ä½œ
- [ ] æ–‡ä»¶ä¸Šä¼ å®‰å…¨å¯é 
- [ ] é™æµæœ‰æ•ˆé˜²æ­¢åˆ·æ¥å£
- [ ] å®‰å…¨å¤´é…ç½®å®Œæ•´
- [ ] æ‰€æœ‰å®‰å…¨æµ‹è¯•é€šè¿‡
- [ ] å®‰å…¨æ–‡æ¡£å®Œå–„

### åŸºç¡€è®¾æ–½å®Œå–„æ ‡å‡†
- [ ] æ‰€æœ‰ä¸­é—´ä»¶æœ‰å®Œæ•´æµ‹è¯•
- [ ] Redis ç¼“å­˜æ­£å¸¸å·¥ä½œ
- [ ] ç»“æ„åŒ–æ—¥å¿—è¾“å‡º
- [ ] é…ç½®éªŒè¯å®Œæ•´
- [ ] é”™è¯¯å¤„ç†ç»Ÿä¸€
- [ ] ç›‘æ§æŒ‡æ ‡æ”¶é›†

---

**å½“å‰çŠ¶æ€**: åŸºç¡€è®¾æ–½ 70% å®Œæˆï¼Œéœ€è¦è¡¥å……å®‰å…¨å’Œç¼“å­˜æ¨¡å—

**ä¸‹ä¸€æ­¥**: å‘Šè¯‰æˆ‘ "å¼€å§‹ CSRF" æˆ– "å¼€å§‹æ–‡ä»¶ä¸Šä¼ " æˆ– "å¼€å§‹ Redis ç¼“å­˜"ï¼Œæˆ‘ä¼šç«‹å³å¼€å§‹å®ç°ï¼
