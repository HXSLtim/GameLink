version: '3.8'

# GameLink Docker Compose 配置示例
# 复制此文件为 docker-compose.yml 并修改相应的值

services:
  # MySQL 数据库
  mysql:
    image: mysql:8.0
    container_name: gamelink_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_CHARSET: utf8mb4
      MYSQL_COLLATION: utf8mb4_unicode_ci
    ports:
      - "${DB_PORT:-3306}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./scripts/sql:/docker-entrypoint-initdb.d:ro
    networks:
      - gamelink_network
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD}"]
      timeout: 20s
      retries: 10
      interval: 10s

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: gamelink_redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - gamelink_network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      timeout: 3s
      retries: 5
      interval: 10s

  # 后端 API 服务
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: gamelink_api
    restart: unless-stopped
    environment:
      # 应用配置
      - APP_ENV=${APP_ENV:-development}
      - DEBUG=${DEBUG:-true}

      # 数据库配置
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}

      # Redis 配置
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DATABASE=${REDIS_DATABASE:-0}

      # JWT 配置
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRE_HOURS=${JWT_EXPIRE_HOURS:-24}

      # 文件上传配置
      - UPLOAD_MAX_SIZE=${UPLOAD_MAX_SIZE:-10485760}
      - UPLOAD_PATH=/app/uploads

      # 日志配置
      - LOG_LEVEL=${LOG_LEVEL:-debug}
      - LOG_FILE=/app/logs/app.log

      # 业务配置
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:5173}
      - RATE_LIMIT_REQUESTS=${RATE_LIMIT_REQUESTS:-100}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW:-60}
    ports:
      - "${API_PORT:-8080}:8080"
    volumes:
      - ./uploads:/app/uploads:rw
      - ./logs:/app/logs:rw
      - ./configs:/app/configs:ro
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - gamelink_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      timeout: 10s
      retries: 5
      interval: 30s
      start_period: 40s

  # 前端应用
  web:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=http://localhost:${API_PORT:-8080}/api/v1
        - VITE_WS_URL=ws://localhost:${API_PORT:-8080}/ws
        - VITE_APP_NAME=${APP_NAME:-GameLink}
        - VITE_APP_VERSION=${APP_VERSION:-2.1.0}
    container_name: gamelink_web
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-5173}:80"
    depends_on:
      api:
        condition: service_healthy
    networks:
      - gamelink_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      timeout: 5s
      retries: 3
      interval: 30s

  # Nginx 反向代理 (可选)
  nginx:
    image: nginx:alpine
    container_name: gamelink_nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./uploads:/var/www/uploads:ro
    depends_on:
      - api
      - web
    networks:
      - gamelink_network
    profiles:
      - production

  # 管理工具 - phpMyAdmin (可选)
  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    container_name: gamelink_phpmyadmin
    restart: unless-stopped
    environment:
      PMA_HOST=mysql
      PMA_USER=root
      PMA_PASSWORD=${DB_ROOT_PASSWORD}
      PMA_ARBITRARY=1
    ports:
      - "8081:80"
    depends_on:
      - mysql
    networks:
      - gamelink_network
    profiles:
      - tools

  # 管理工具 - Redis Commander (可选)
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: gamelink_redis_commander
    restart: unless-stopped
    environment:
      REDIS_HOSTS=local:redis:6379:0:${REDIS_PASSWORD}
    ports:
      - "8082:8081"
    depends_on:
      - redis
    networks:
      - gamelink_network
    profiles:
      - tools

  # 监控 - Prometheus (可选)
  prometheus:
    image: prom/prometheus:latest
    container_name: gamelink_prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - gamelink_network
    profiles:
      - monitoring

  # 监控 - Grafana (可选)
  grafana:
    image: grafana/grafana:latest
    container_name: gamelink_grafana
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_USER=admin
      GF_SECURITY_ADMIN_PASSWORD=admin123
      GF_USERS_ALLOW_SIGN_UP=false
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      - prometheus
    networks:
      - gamelink_network
    profiles:
      - monitoring

  # 日志收集 - Filebeat (可选)
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.5.0
    container_name: gamelink_filebeat
    restart: unless-stopped
    user: root
    environment:
      - output.elasticsearch.hosts=["elasticsearch:9200"]
    volumes:
      - ./monitoring/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - ./logs:/logs:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - api
    networks:
      - gamelink_network
    profiles:
      - logging

  # 日志存储 - Elasticsearch (可选)
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.5.0
    container_name: gamelink_elasticsearch
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - gamelink_network
    profiles:
      - logging

  # 日志可视化 - Kibana (可选)
  kibana:
    image: docker.elastic.co/kibana/kibana:8.5.0
    container_name: gamelink_kibana
    restart: unless-stopped
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
    networks:
      - gamelink_network
    profiles:
      - logging

# 数据卷
volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  elasticsearch_data:
    driver: local

# 网络
networks:
  gamelink_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16