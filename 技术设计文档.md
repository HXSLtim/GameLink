# ğŸ”§ GameLink æŠ€æœ¯è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

**æ–‡æ¡£ç±»å‹**: æŠ€æœ¯å®ç°è®¾è®¡
**å…³è”æ–‡æ¡£**: GameLink_å®Œæ•´åŠŸèƒ½è§„åˆ’æ–‡æ¡£.md
**ç›®æ ‡è¯»è€…**: å¼€å‘å›¢é˜Ÿ
**ç»´æŠ¤ç­–ç•¥**: éšä»£ç å®ç°åŒæ­¥æ›´æ–°

---

## ğŸ” è®¤è¯æˆæƒç³»ç»Ÿå®ç°

### JWTè®¤è¯æœºåˆ¶

```go
// JWT Tokenç»“æ„
type Claims struct {
    UserID   uint64 `json:"user_id"`
    Username string `json:"username"`
    Role     string `json:"role"`
    Exp      int64  `json:"exp"`
    Iat      int64  `json:"iat"`
}

// è®¤è¯ä¸­é—´ä»¶
func AuthMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        // TokenéªŒè¯é€»è¾‘
        // è§’è‰²æƒé™æ£€æŸ¥
        // ç”¨æˆ·çŠ¶æ€éªŒè¯
    }
}
```

### è§’è‰²æƒé™ç³»ç»Ÿ (RBAC)

```sql
-- è§’è‰²è¡¨
CREATE TABLE roles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL,
    description TEXT,
    permissions JSON NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç”¨æˆ·è§’è‰²å…³è”è¡¨
CREATE TABLE user_roles (
    user_id BIGINT NOT NULL,
    role_id BIGINT NOT NULL,
    granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, role_id)
);
```

---

## ğŸ’³ æ”¯ä»˜ç³»ç»Ÿå®ç°

### æ”¯ä»˜æœåŠ¡æ¥å£

```go
// æ”¯ä»˜æœåŠ¡æ¥å£
type PaymentService interface {
    CreatePayment(order *Order, method PaymentMethod) (*Payment, error)
    HandleCallback(provider string, data CallbackData) error
    RefundPayment(payment *Payment, amount int64) error
    QueryPaymentStatus(paymentID string) (PaymentStatus, error)
}

// æ”¯ä»˜å®é›†æˆ
type AlipayService struct {
    client *alipay.Client
}

// å¾®ä¿¡æ”¯ä»˜é›†æˆ
type WechatPayService struct {
    client *wechatpay.Client
}
```

### æ”¯ä»˜å®‰å…¨æœºåˆ¶

- âœ… ç­¾åéªŒè¯
- âœ… é‡‘é¢é™åˆ¶ (1åˆ† - 100ä¸‡å…ƒ)
- âœ… é‡å¤æ”¯ä»˜æ£€æµ‹
- âœ… è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ
- âœ… äº‹åŠ¡ä¿æŠ¤

---

## ğŸ’¬ å®æ—¶èŠå¤©ç³»ç»Ÿå®ç°

### WebSocketæ¶æ„

```go
type Hub struct {
    clients    map[uint64]*Client
    broadcast  chan *Message
    register   chan *Client
    unregister chan *Client
}

type Client struct {
    hub    *Hub
    conn   *websocket.Conn
    userID uint64
    send   chan []byte
}

type Message struct {
    ID             uint64    `json:"id"`
    ConversationID uint64    `json:"conversation_id"`
    SenderID       uint64    `json:"sender_id"`
    ReceiverID     uint64    `json:"receiver_id"`
    Content        string    `json:"content"`
    MessageType    string    `json:"message_type"`
    CreatedAt      time.Time `json:"created_at"`
}
```

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡å®ç°

### æ ¸å¿ƒæ•°æ®è¡¨

#### ç”¨æˆ·ç›¸å…³è¡¨

```sql
-- ç”¨æˆ·åŸºç¡€è¡¨
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE,
    phone VARCHAR(20) UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    avatar_url VARCHAR(500),
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_phone (phone)
);

-- é™ªç©å¸ˆè®¤è¯è¡¨
CREATE TABLE players (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT UNIQUE NOT NULL,
    real_name VARCHAR(50),
    id_card VARCHAR(20),
    bio TEXT,
    rating_avg DECIMAL(3,2) DEFAULT 0.00,
    rating_count INT DEFAULT 0,
    order_count INT DEFAULT 0,
    status VARCHAR(20) DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_status (status),
    INDEX idx_rating (rating_avg)
);
```

#### æ¸¸æˆç›¸å…³è¡¨

```sql
-- æ¸¸æˆè¡¨
CREATE TABLE games (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    icon_url VARCHAR(500),
    category VARCHAR(50),
    description TEXT,
    tags JSON,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_category (category),
    INDEX idx_active (is_active)
);

-- é™ªç©å¸ˆæ¸¸æˆæŠ€èƒ½è¡¨
CREATE TABLE player_games (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    player_id BIGINT NOT NULL,
    game_id BIGINT NOT NULL,
    skill_level VARCHAR(20),
    price_per_hour INT NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_player_game (player_id, game_id),
    FOREIGN KEY (player_id) REFERENCES players(id),
    FOREIGN KEY (game_id) REFERENCES games(id)
);
```

#### è®¢å•ç›¸å…³è¡¨

```sql
-- è®¢å•è¡¨
CREATE TABLE orders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_no VARCHAR(50) UNIQUE NOT NULL,
    user_id BIGINT NOT NULL,
    player_id BIGINT NOT NULL,
    game_id BIGINT NOT NULL,
    duration_hours INT NOT NULL,
    unit_price_cents INT NOT NULL,
    total_price_cents INT NOT NULL,
    scheduled_time TIMESTAMP,
    status VARCHAR(20) DEFAULT 'pending',
    special_requirements TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (player_id) REFERENCES players(id),
    FOREIGN KEY (game_id) REFERENCES games(id),
    INDEX idx_user_id (user_id),
    INDEX idx_player_id (player_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);

-- æ”¯ä»˜è¡¨
CREATE TABLE payments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT UNIQUE NOT NULL,
    payment_no VARCHAR(50) UNIQUE NOT NULL,
    amount_cents INT NOT NULL,
    method VARCHAR(20) NOT NULL,
    provider VARCHAR(20),
    provider_transaction_id VARCHAR(100),
    status VARCHAR(20) DEFAULT 'pending',
    paid_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(id),
    INDEX idx_order_id (order_id),
    INDEX idx_status (status),
    INDEX idx_provider_tx (provider_transaction_id)
);
```

#### è¯„ä»·ç³»ç»Ÿè¡¨

```sql
-- è¯„ä»·è¡¨
CREATE TABLE reviews (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT UNIQUE NOT NULL,
    user_id BIGINT NOT NULL,
    player_id BIGINT NOT NULL,
    rating INT NOT NULL CHECK (rating >= 1 AND rating <= 5),
    comment TEXT,
    is_visible BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (player_id) REFERENCES players(id),
    INDEX idx_player_id (player_id),
    INDEX idx_rating (rating),
    INDEX idx_created_at (created_at)
);
```

#### è¥é”€ç³»ç»Ÿè¡¨

```sql
-- ä¼˜æƒ åˆ¸æ¨¡æ¿
CREATE TABLE coupon_templates (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    type VARCHAR(20) NOT NULL, -- discount, cashback
    discount_type VARCHAR(20), -- percentage, fixed
    discount_value INT NOT NULL,
    min_order_amount INT DEFAULT 0,
    total_quantity INT NOT NULL,
    valid_from TIMESTAMP NOT NULL,
    valid_to TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç”¨æˆ·ä¼˜æƒ åˆ¸
CREATE TABLE user_coupons (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    template_id BIGINT NOT NULL,
    coupon_code VARCHAR(50) UNIQUE NOT NULL,
    status VARCHAR(20) DEFAULT 'unused',
    used_at TIMESTAMP,
    order_id BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- è¥é”€æ´»åŠ¨è¡¨
CREATE TABLE marketing_campaigns (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    type VARCHAR(50) NOT NULL, -- new_user, recharge, invite
    description TEXT,
    rules JSON NOT NULL,
    rewards JSON NOT NULL,
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP NOT NULL,
    status VARCHAR(20) DEFAULT 'draft',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### ä¼šå‘˜ç³»ç»Ÿè¡¨

```sql
-- ä¼šå‘˜ç­‰çº§è¡¨
CREATE TABLE membership_tiers (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL,
    type VARCHAR(20) NOT NULL, -- user_vip, player_certified
    price_cents INT NOT NULL,
    duration_days INT NOT NULL,
    benefits JSON NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ä¼šå‘˜è®¢é˜…è¡¨
CREATE TABLE memberships (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    tier_id BIGINT NOT NULL,
    start_date TIMESTAMP NOT NULL,
    end_date TIMESTAMP NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    auto_renew BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### æ•°æ®åº“ä¼˜åŒ–ç­–ç•¥

#### ç´¢å¼•ä¼˜åŒ–

```sql
-- å¤åˆç´¢å¼•
CREATE INDEX idx_orders_user_status ON orders(user_id, status, created_at);
CREATE INDEX idx_players_game_status ON players(game_id, status, rating_avg);
CREATE INDEX idx_payments_status_provider ON payments(status, provider, created_at);

-- è¦†ç›–ç´¢å¼•
CREATE INDEX idx_orders_list_covering ON orders(status, created_at, id, user_id, player_id, total_price_cents);
```

#### åˆ†è¡¨ç­–ç•¥

```sql
-- æŒ‰æœˆåˆ†è¡¨ï¼ˆè®¢å•è¡¨ï¼‰
CREATE TABLE orders_202401 LIKE orders;
CREATE TABLE orders_202402 LIKE orders;

-- åˆ†è¡¨æŸ¥è¯¢è·¯ç”±
SELECT * FROM orders_202401 WHERE created_at >= '2024-01-01' AND created_at < '2024-02-01';
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–å®ç°

### ç¼“å­˜ç­–ç•¥

```go
// å¤šçº§ç¼“å­˜
1. æœ¬åœ°ç¼“å­˜ (go-cache) - çƒ­ç‚¹æ•°æ® (TTL: 5åˆ†é’Ÿ)
2. Redisç¼“å­˜ - å…±äº«æ•°æ® (TTL: 30åˆ†é’Ÿ)
3. æ•°æ®åº“ - æŒä¹…åŒ–æ•°æ®

// ç¼“å­˜ä½¿ç”¨åœºæ™¯
- ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ (key: user:{id}, TTL: 10åˆ†é’Ÿ)
- é™ªç©å¸ˆåˆ—è¡¨ç¼“å­˜ (key: players:list:{filters}, TTL: 5åˆ†é’Ÿ)
- æ¸¸æˆåˆ—è¡¨ç¼“å­˜ (key: games:list, TTL: 30åˆ†é’Ÿ)
- çƒ­é—¨æ•°æ®ç¼“å­˜ (key: hot:players, TTL: 1å°æ—¶)
```

### æ•°æ®åº“ä¼˜åŒ–

```sql
-- æ…¢æŸ¥è¯¢ä¼˜åŒ–
1. åˆç†ä½¿ç”¨ç´¢å¼•
2. é¿å…å…¨è¡¨æ‰«æ
3. åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ– (LIMIT offset, size)
4. ç»Ÿè®¡æŸ¥è¯¢ä¼˜åŒ– (é¢„è®¡ç®—/å®šæ—¶ä»»åŠ¡)

-- è¿æ¥æ± é…ç½®
max_connections: 100
max_idle: 10
max_lifetime: 1h
```

---

## ğŸ“ˆ ç›‘æ§å‘Šè­¦å®ç°

### PrometheusæŒ‡æ ‡

```go
// åº”ç”¨ç›‘æ§æŒ‡æ ‡
http_requests_total{method, status}
http_request_duration_seconds
active_connections_total
database_connections_active
cache_hit_ratio
```

### å‘Šè­¦è§„åˆ™

```yaml
# å‘Šè­¦è§„åˆ™
groups:
  - name: application
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1

      - alert: HighResponseTime
        expr: histogram_quantile(0.95, http_request_duration_seconds) > 0.5

      - alert: DatabaseConnectionHigh
        expr: database_connections_active > 80
```

---

## ğŸš€ éƒ¨ç½²æ¶æ„å®ç°

### å®¹å™¨åŒ–éƒ¨ç½²

```dockerfile
# åº”ç”¨å®¹å™¨
FROM golang:1.25-alpine AS builder
WORKDIR /app
COPY . .
RUN go build -o gamelink

FROM alpine:latest
RUN apk --no-cache add ca-certificates
COPY --from=builder /app/gamelink /app/gamelink
CMD ["/app/gamelink"]
```

### CI/CDæµç¨‹

```yaml
# GitHub Actions
name: CI/CD
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run tests
        run: go test ./...

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Build Docker image
        run: docker build -t gamelink .

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to production
        run: kubectl apply -f k8s/
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
**åˆ›å»ºæ—¶é—´**: 2025å¹´1æœˆ10æ—¥
**ç»´æŠ¤å›¢é˜Ÿ**: GameLinkå¼€å‘å›¢é˜Ÿ
