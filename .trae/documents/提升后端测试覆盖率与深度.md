## 目标与范围
- 提升后端整体测试覆盖率与测试深度，重点覆盖未触达的错误分支与幂等路径
- 目标：
  - admin handler ≥ 55%
  - db 包 ≥ 80%
  - repository/ranking ≥ 80%
  - 保持现有已高覆盖模块稳定

## 阶段一：Admin Handlers 覆盖增强
- 用户模块
  - CreateUserWithPlayer：补充无效邮箱/手机号、缺失必填字段、ErrValidation 映射
  - ListUserLogs：补充 `export=csv` 路径测试（构造 operation logs 列表，验证字段选择、中文表头、时区与 BOM）
- 订单模块
  - UpdateOrder：补充无效 `currency`、负数价格、开始时间晚于结束时间、非法状态流转（ErrOrderInvalidTransition）
  - Confirm/Start/Complete：补充非数字路径 ID、无 body 与带备注两种分支
  - RefundOrder：补充分支（原因为空、不允许的订单状态、退款金额为负或超额）
  - ListOrderLogs：补充 `export=csv` 路径同上
- 支付模块
  - CapturePayment：非法状态流转、无效时间、缺字段校验
  - UpdatePayment：非法 `status` 与非法状态流转分支、`refunded_at/paid_at` 无效时间
  - RefundPayment：仅允许从 paid 退款，其他状态分支验证

## 阶段二：DB 包覆盖增强
- prepareOrdersMigration：
  - 已存在列时重复执行的幂等性测试
  - `price_cents → unit_price_cents/total_price_cents` 迁移分支（存在/不存在旧列）
- ensureIndexes：
  - 已添加索引再次执行的幂等性测试
  - 模拟执行失败路径（构造错误 SQL）
- ensureDefaultCommissionRule：
  - 已存在默认规则路径（保持单条），模拟 DB 错误路径
- runDataFixups：
  - 订单状态 `cancelled → canceled` 路径已测基础上，补充 RBAC 默认角色与抽成规则确保分支
- generateOrderNumbers：
  - 订单号唯一性、空字符串与 NULL 路径组合

## 阶段三：Repository/ranking 覆盖增强
- 列表查询：分页、排序与筛选组合（如月份、状态、player_id）
- 预加载：验证避免 N+1 的预加载路径（如 `PlayerRanking` 关联）
- 计数与总页数计算：边界页与空结果

## 阶段四：Admin Service 业务分支
- UpdateOrder：全面状态机负路径与元数据记录（cancel/refund 备注与时间项）
- RefundOrder：金额边界、原因必填、联动支付更新的分支（支付已退款/待支付/已支付）
- UpdatePayment：合法/非法状态流转、日志追加、缓存失效验证（使用 MemoryCache）
- ListOperationLogs/Reviews：使用 TxManager 测试桩模拟分页合并逻辑

## 阶段五：测试支撑与规范
- 复用/扩展现有 fake repositories，增加必要行为（如分页与筛选）
- 使用 gin TestMode + 统一错误中间件，保证错误映射一致性
- 使用 AAA 模式与表驱动测试覆盖多场景；context 传递与日志字段注入（request_id/actor_user_id）
- 在需要时用 `t.Setenv` 控制环境变量（如 ADMIN_LIST_TTL）避免全局污染

## 验证与度量
- 运行 `go test ./... -cover`，记录关键包覆盖率变化
- 若个别模块未达目标，补充缺口分支用例，确保稳定通过
- 保持测试无副作用、幂等；避免依赖外部服务

## 交付内容
- 新增/更新测试文件（仅测试目录）
- 详细变更说明与覆盖率对比
- 后续提升建议（如集成测试与 E2E 路由验证）