---
globs: backend/**/*.go
description: åç«¯æ¶æ„å’Œåˆ†å±‚è§„èŒƒ
---

# åç«¯æ¶æ„è§„èŒƒ

## å››å±‚æ¶æ„è®¾è®¡

GameLink åç«¯é‡‡ç”¨ä¸¥æ ¼çš„å››å±‚æ¶æ„ï¼š

```
HTTP è¯·æ±‚
   â†“
ğŸ¯ Handler å±‚ (HTTP å¤„ç†)
   â†“
ğŸ’¼ Service å±‚ (ä¸šåŠ¡é€»è¾‘)
   â†“
ğŸ—„ï¸ Repository å±‚ (æ•°æ®è®¿é—®)
   â†“
ğŸ“Š Model å±‚ (æ•°æ®æ¨¡å‹)
   â†“
æ•°æ®åº“
```

## å„å±‚èŒè´£

### Model å±‚
- **èŒè´£**: çº¯æ•°æ®æ¨¡å‹å®šä¹‰
- **ç¦æ­¢**: åŒ…å«ä»»ä½•ä¸šåŠ¡é€»è¾‘
- **ä½ç½®**: `internal/model/`
- **ç¤ºä¾‹**:
```go
type User struct {
    ID        uint64    `gorm:"primaryKey" json:"id"`
    Phone     string    `gorm:"uniqueIndex;not null" json:"phone"`
    Name      string    `gorm:"size:100;not null" json:"name"`
    Role      UserRole  `gorm:"type:varchar(20);not null" json:"role"`
    CreatedAt time.Time `json:"createdAt"`
    UpdatedAt time.Time `json:"updatedAt"`
}
```

### Repository å±‚
- **èŒè´£**: çº¯æ•°æ®è®¿é—®æ“ä½œ (CRUD)
- **ç¦æ­¢**: åŒ…å«ä¸šåŠ¡é€»è¾‘
- **ä½ç½®**: `internal/repository/`
- **è§„èŒƒ**:
  - å¿…é¡»å®šä¹‰æ¥å£
  - ç¬¬ä¸€ä¸ªå‚æ•°æ€»æ˜¯ `context.Context`
  - ä½¿ç”¨ä¾èµ–æ³¨å…¥

**ç¤ºä¾‹**:
```go
// æ¥å£å®šä¹‰
type UserRepository interface {
    Create(ctx context.Context, user *model.User) error
    GetByID(ctx context.Context, id uint64) (*model.User, error)
    Update(ctx context.Context, user *model.User) error
    Delete(ctx context.Context, id uint64) error
}

// å®ç°
type userRepository struct {
    db *gorm.DB
}

func NewUserRepository(db *gorm.DB) UserRepository {
    return &userRepository{db: db}
}
```

### Service å±‚
- **èŒè´£**: ä¸šåŠ¡é€»è¾‘å¤„ç†
- **ç¦æ­¢**: ç›´æ¥å¤„ç† HTTP è¯·æ±‚/å“åº”
- **ä½ç½®**: `internal/service/`
- **è§„èŒƒ**:
  - ä¾èµ– Repository æ¥å£è€Œéå…·ä½“å®ç°
  - å¤„ç†ä¸šåŠ¡éªŒè¯å’Œé”™è¯¯
  - åŒ…è£…é”™è¯¯ä¿¡æ¯

**ç¤ºä¾‹**:
```go
type UserService struct {
    repo  repository.UserRepository
    cache cache.Cache
}

func (s *UserService) CreateUser(ctx context.Context, req *CreateUserRequest) error {
    // ä¸šåŠ¡éªŒè¯
    if err := s.validateUser(req); err != nil {
        return fmt.Errorf("validation failed: %w", err)
    }

    // ä¸šåŠ¡é€»è¾‘
    user := req.ToModel()
    if err := s.repo.Create(ctx, user); err != nil {
        return fmt.Errorf("failed to create user: %w", err)
    }

    return nil
}
```

### Handler å±‚
- **èŒè´£**: HTTP è¯·æ±‚/å“åº”å¤„ç†
- **ç¦æ­¢**: åŒ…å«ä¸šåŠ¡é€»è¾‘
- **ä½ç½®**: `internal/handler/`
- **è§„èŒƒ**:
  - æŒ‰è§’è‰²ç»„ç»‡ (admin/, user/, player/)
  - åªå¤„ç† HTTP ç›¸å…³æ“ä½œ
  - è°ƒç”¨ Service å±‚æ–¹æ³•

**ç¤ºä¾‹**:
```go
type UserHandler struct {
    service *service.UserService
}

func (h *UserHandler) CreateUser(c *gin.Context) {
    var req CreateUserRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
        return
    }

    if err := h.service.CreateUser(c.Request.Context(), &req); err != nil {
        c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
        return
    }

    c.JSON(http.StatusCreated, gin.H{"message": "success"})
}
```

## ç›®å½•ç»“æ„è§„èŒƒ

```
internal/
â”œâ”€â”€ model/                    # æ•°æ®æ¨¡å‹ (çº¯å®šä¹‰)
â”‚   â”œâ”€â”€ user.go
â”‚   â”œâ”€â”€ order.go
â”‚   â””â”€â”€ ...
â”œâ”€â”€ repository/               # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ interfaces.go         # æ‰€æœ‰ Repository æ¥å£
â”‚   â”œâ”€â”€ user_repository.go
â”‚   â”œâ”€â”€ order_repository.go
â”‚   â””â”€â”€ ...
â”œâ”€â”€ service/                  # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â””â”€â”€ auth.go
â”‚   â”œâ”€â”€ order/
â”‚   â”‚   â””â”€â”€ order.go
â”‚   â””â”€â”€ ...
â””â”€â”€ handler/                  # HTTP å¤„ç†å±‚
    â”œâ”€â”€ admin/               # ç®¡ç†ç«¯ Handler
    â”‚   â”œâ”€â”€ user.go
    â”‚   â”œâ”€â”€ order.go
    â”‚   â””â”€â”€ router.go
    â”œâ”€â”€ user/                # ç”¨æˆ·ç«¯ Handler
    â””â”€â”€ player/              # é™ªç©å¸ˆç«¯ Handler
```

## ä¾èµ–æ³¨å…¥åŸåˆ™

ä½¿ç”¨æ„é€ å‡½æ•°è¿›è¡Œä¾èµ–æ³¨å…¥ï¼š

```go
// Service ä¾èµ– Repository æ¥å£
func NewUserService(repo repository.UserRepository, cache cache.Cache) *UserService {
    return &UserService{
        repo:  repo,
        cache: cache,
    }
}

// Handler ä¾èµ– Service
func NewUserHandler(service *service.UserService) *UserHandler {
    return &UserHandler{
        service: service,
    }
}
```

## å…³é”®åŸåˆ™

1. **å•å‘ä¾èµ–**: Handler â†’ Service â†’ Repository â†’ Model
2. **æ¥å£éš”ç¦»**: ä½¿ç”¨æ¥å£è€Œéå…·ä½“å®ç°
3. **èŒè´£å•ä¸€**: æ¯å±‚åªåšè‡ªå·±çš„äº‹æƒ…
4. **ä¾èµ–æ³¨å…¥**: é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–
5. **é”™è¯¯åŒ…è£…**: æ¯å±‚éƒ½åº”è¯¥åŒ…è£…é”™è¯¯ï¼Œæä¾›ä¸Šä¸‹æ–‡ä¿¡æ¯
