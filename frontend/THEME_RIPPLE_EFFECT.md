# ä¸»é¢˜åˆ‡æ¢æ‰©æ•£åŠ¨ç”»å®ç°

## ğŸ¨ åŠŸèƒ½æ¦‚è¿°

ä¸ºä¸»é¢˜åˆ‡æ¢æ·»åŠ äº†ä¼˜é›…çš„æ‰©æ•£åŠ¨ç”»æ•ˆæœï¼Œä½¿ç”¨ **CSS é¢œè‰²åè½¬æ»¤é•œ** (`filter: invert(1)`) å®ç°æ— ç¼çš„ä¸»é¢˜åˆ‡æ¢ä½“éªŒã€‚

## âœ¨ æ•ˆæœæ¼”ç¤º

å½“ç”¨æˆ·ç‚¹å‡»ä¸»é¢˜åˆ‡æ¢æŒ‰é’®æ—¶ï¼š

1. åˆ›å»ºä¸€ä¸ªå…¨å±çš„é¢œè‰²åè½¬é®ç½©å±‚
2. ä½¿ç”¨ `clip-path: circle()` ä»ç‚¹å‡»ä½ç½®åˆ›å»ºåœ†å½¢æ‰©æ•£æ•ˆæœ
3. åè½¬åŒºåŸŸçš„é¢œè‰²é€æ¸æ‰©æ•£åˆ°æ•´ä¸ªå±å¹•
4. æ‰©æ•£å®Œæˆåï¼ˆ600msï¼‰åˆ‡æ¢ä¸»é¢˜ç±»åå¹¶ç§»é™¤é®ç½©
5. å®Œç¾æ— ç¼ï¼Œæ²¡æœ‰é¢œè‰²ä¸åŒ¹é…çš„é—®é¢˜

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. ThemeContext æ”¹é€ 

#### ä¿®æ”¹æ¥å£

```typescript
interface ThemeContextValue {
  mode: ThemeMode;
  effective: EffectiveTheme;
  setMode: (mode: ThemeMode, x?: number, y?: number) => void; // æ–°å¢åæ ‡å‚æ•°
}
```

#### æ ¸å¿ƒæ‰©æ•£å‡½æ•°ï¼ˆä½¿ç”¨é¢œè‰²åè½¬æ»¤é•œï¼‰

```typescript
const applyThemeWithRipple = (theme: EffectiveTheme, x: number, y: number): void => {
  // 1. åˆ›å»ºå…¨å±åè½¬é®ç½©
  const overlay = document.createElement('div');
  overlay.className = 'theme-ripple-overlay';

  // 2. è®¡ç®—åˆ°æœ€è¿œè§’çš„è·ç¦»ï¼ˆç¡®ä¿è¦†ç›–æ•´ä¸ªå±å¹•ï¼‰
  const maxDistance = Math.hypot(
    Math.max(x, window.innerWidth - x),
    Math.max(y, window.innerHeight - y),
  );
  const maxSize = maxDistance * 2;

  // 3. è®¾ç½®é®ç½©æ ·å¼ï¼ˆå…¨å± + é¢œè‰²åè½¬ + clip-path è£å‰ªï¼‰
  Object.assign(overlay.style, {
    position: 'fixed',
    top: '0',
    left: '0',
    width: '100%',
    height: '100%',
    pointerEvents: 'none',
    zIndex: '9999',
    filter: 'invert(1)', // ğŸŒŸ å…³é”®ï¼šé¢œè‰²åè½¬æ»¤é•œ
    clipPath: `circle(0px at ${x}px ${y}px)`, // åˆå§‹ï¼šä»ç‚¹å‡»ä½ç½®çš„ 0px åœ†
    transition: 'clip-path 0.6s cubic-bezier(0.4, 0, 0.2, 1)',
  });

  document.body.appendChild(overlay);

  // 4. è§¦å‘æ‰©æ•£åŠ¨ç”»
  requestAnimationFrame(() => {
    overlay.style.clipPath = `circle(${maxSize}px at ${x}px ${y}px)`; // æ‰©æ•£åˆ°æœ€å¤§
  });

  // 5. æ‰©æ•£å®Œæˆååˆ‡æ¢ä¸»é¢˜å¹¶ç§»é™¤é®ç½©
  setTimeout(() => {
    // åˆ‡æ¢ä¸»é¢˜ç±»å
    if (theme === 'dark') {
      html.classList.add(DARK_THEME_CLASS);
      body.classList.add(DARK_THEME_CLASS);
    } else {
      html.classList.remove(DARK_THEME_CLASS);
      body.classList.remove(DARK_THEME_CLASS);
    }

    // ç§»é™¤é®ç½©ï¼ˆæ­¤æ—¶ä¸»é¢˜å·²åˆ‡æ¢ï¼Œé®ç½©ä¸å†éœ€è¦ï¼‰
    overlay.remove();
  }, 600);
};
```

### 2. Header ç»„ä»¶é›†æˆ

```typescript
const toggleTheme = (event: React.MouseEvent<HTMLButtonElement>) => {
  // è·å–ç‚¹å‡»åæ ‡
  const x = event.clientX;
  const y = event.clientY;

  // ä¼ é€’åæ ‡ç»™ä¸»é¢˜åˆ‡æ¢å‡½æ•°
  setMode(effective === 'light' ? 'dark' : 'light', x, y);
};
```

### 3. å…¨å±€æ ·å¼ä¼˜åŒ–

```less
// global.less
.theme-ripple-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 9999;
  will-change: clip-path;

  // ğŸŒŸ é¢œè‰²åè½¬æ»¤é•œï¼šé»‘å˜ç™½ï¼Œç™½å˜é»‘
  filter: invert(1);

  // ç¡¬ä»¶åŠ é€Ÿä¼˜åŒ–
  transform: translateZ(0);
  backface-visibility: hidden;
}
```

## ğŸ“ åŠ¨ç”»å‚æ•°

| å‚æ•°         | å€¼                           | è¯´æ˜                         |
| ------------ | ---------------------------- | ---------------------------- |
| åŠ¨ç”»æ€»æ—¶é•¿   | 600ms                        | ä»å¼€å§‹åˆ°ç»“æŸçš„æ€»æ—¶é—´         |
| ä¸»é¢˜åˆ‡æ¢æ—¶æœº | 600ms                        | æ‰©æ•£å®Œæˆååˆ‡æ¢ï¼ˆæ— ç¼è¡”æ¥ï¼‰   |
| ç¼“åŠ¨å‡½æ•°     | cubic-bezier(0.4, 0, 0.2, 1) | ç±»ä¼¼ ease-outï¼Œå¹³æ»‘åŠ é€Ÿ      |
| Z-index      | 9999                         | ç¡®ä¿åœ¨æ‰€æœ‰å…ƒç´ ä¹‹ä¸Š           |
| å½¢çŠ¶         | åœ†å½¢ï¼ˆclip-path: circle()ï¼‰  | æ‰©æ•£æ•ˆæœ                     |
| é¢œè‰²åè½¬     | filter: invert(1)            | åè½¬æ‰€æœ‰é¢œè‰²ï¼Œé»‘å˜ç™½ï¼Œç™½å˜é»‘ |

## ğŸ¯ è®¾è®¡åŸç†

### 1. è·ç¦»è®¡ç®—

ä½¿ç”¨å‹¾è‚¡å®šç†è®¡ç®—ç‚¹å‡»ä½ç½®åˆ°å±å¹•æœ€è¿œè§’çš„è·ç¦»ï¼š

```typescript
const maxDistance = Math.hypot(
  Math.max(x, window.innerWidth - x), // æ¨ªå‘æœ€è¿œè·ç¦»
  Math.max(y, window.innerHeight - y), // çºµå‘æœ€è¿œè·ç¦»
);
```

### 2. æ—¶é—´æ§åˆ¶

- **0ms**: åˆ›å»ºå…¨å±åè½¬é®ç½©ï¼Œ`clip-path: circle(0px)` ä»ç‚¹å‡»ä½ç½®å¼€å§‹
- **1 å¸§å**: è§¦å‘ CSS è¿‡æ¸¡ï¼Œåœ†å½¢å¼€å§‹æ‰©æ•£
- **600ms**: æ‰©æ•£å®Œæˆï¼Œåˆ‡æ¢ä¸»é¢˜ç±»åå¹¶ç§»é™¤é®ç½©

**å…³é”®æ”¹è¿›**ï¼šä¸å†åœ¨åŠ¨ç”»ä¸­é€”åˆ‡æ¢ï¼Œè€Œæ˜¯ç­‰æ‰©æ•£å®Œå…¨è¦†ç›–åå†åˆ‡æ¢ï¼Œç¡®ä¿è§†è§‰å®Œç¾è¡”æ¥ã€‚

### 3. æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨ `will-change: clip-path` æç¤ºæµè§ˆå™¨ä¼˜åŒ– clip-path åŠ¨ç”»
- ä½¿ç”¨ `pointer-events: none` é¿å…é˜»å¡äº¤äº’
- ä½¿ç”¨ `transform: translateZ(0)` å’Œ `backface-visibility: hidden` å¼€å¯ç¡¬ä»¶åŠ é€Ÿ
- ä½¿ç”¨ `requestAnimationFrame` ç¡®ä¿åŠ¨ç”»æµç•…
- åŠ¨ç”»å®Œæˆåç«‹å³æ¸…ç† DOM å…ƒç´ 

### 4. é¢œè‰²åè½¬åŸç†

ä½¿ç”¨ `filter: invert(1)` åè½¬é®ç½©è¦†ç›–åŒºåŸŸçš„æ‰€æœ‰é¢œè‰²ï¼š

- é»‘è‰² (`#000000`) â†’ ç™½è‰² (`#FFFFFF`)
- ç™½è‰² (`#FFFFFF`) â†’ é»‘è‰² (`#000000`)
- ç°è‰²ä¹Ÿä¼šç›¸åº”åè½¬

é€šè¿‡ `clip-path: circle()` æ§åˆ¶åè½¬åŒºåŸŸçš„å¤§å°ï¼Œä»ç‚¹å‡»ä½ç½®é€æ¸æ‰©æ•£åˆ°å…¨å±ï¼Œå®ç°å¹³æ»‘çš„é¢œè‰²è¿‡æ¸¡ã€‚

## ğŸŒˆ é¢œè‰²åè½¬é€»è¾‘

ä½¿ç”¨ CSS `filter: invert(1)` å®ç°é¢œè‰²åè½¬ï¼Œæ— éœ€æ‰‹åŠ¨æŒ‡å®šé¢œè‰²ï¼š

- **æµ…è‰² â†’ æ·±è‰²**ï¼šåè½¬åï¼Œç™½è‰²èƒŒæ™¯å˜é»‘è‰²ï¼Œé»‘è‰²æ–‡å­—å˜ç™½è‰²
- **æ·±è‰² â†’ æµ…è‰²**ï¼šåè½¬åï¼Œé»‘è‰²èƒŒæ™¯å˜ç™½è‰²ï¼Œç™½è‰²æ–‡å­—å˜é»‘è‰²

**ä¼˜åŠ¿**ï¼š

1. âœ… **å®Œç¾åŒ¹é…**ï¼šåè½¬åçš„é¢œè‰²æ­£å¥½æ˜¯ç›®æ ‡ä¸»é¢˜çš„é¢œè‰²
2. âœ… **æ— ç¼è¡”æ¥**ï¼šæ‰©æ•£å®Œæˆæ—¶ï¼Œåè½¬åŒºåŸŸçš„é¢œè‰²ä¸ä¸»é¢˜åˆ‡æ¢åçš„é¢œè‰²å®Œå…¨ä¸€è‡´
3. âœ… **è‡ªåŠ¨é€‚é…**ï¼šæ”¯æŒä»»ä½•é¢œè‰²ï¼Œä¸ä»…é™äºé»‘ç™½ï¼ˆç°åº¦ä¹Ÿä¼šæ­£ç¡®åè½¬ï¼‰
4. âœ… **ç®€å•å®ç°**ï¼šä¸€è¡Œ CSS å³å¯ï¼Œæ— éœ€è®¡ç®—ç›®æ ‡é¢œè‰²

## ğŸ”„ å…¼å®¹æ€§å¤„ç†

### ä¸»åŠ¨åˆ‡æ¢ vs ç³»ç»Ÿåˆ‡æ¢

- **ä¸»åŠ¨åˆ‡æ¢**ï¼ˆç‚¹å‡»æŒ‰é’®ï¼‰ï¼šä½¿ç”¨æ‰©æ•£åŠ¨ç”»
- **ç³»ç»Ÿåˆ‡æ¢**ï¼ˆå“åº”ç³»ç»Ÿä¸»é¢˜å˜åŒ–ï¼‰ï¼šç›´æ¥åˆ‡æ¢ï¼Œæ— åŠ¨ç”»

```typescript
// ä¸»åŠ¨åˆ‡æ¢æ—¶ä¼ é€’åæ ‡
setMode('dark', x, y); // æœ‰åŠ¨ç”»

// ç³»ç»Ÿåˆ‡æ¢æ—¶ä¸ä¼ é€’åæ ‡
setMode('system'); // æ— åŠ¨ç”»
```

### åˆå§‹åŒ–å’Œæ¢å¤

åº”ç”¨å¯åŠ¨æ—¶æ¢å¤ä¸»é¢˜ä¸ä¼šè§¦å‘åŠ¨ç”»ï¼Œåªåœ¨ç”¨æˆ·ä¸»åŠ¨åˆ‡æ¢æ—¶æ‰æ˜¾ç¤ºã€‚

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

```
ç”¨æˆ·ç‚¹å‡»æŒ‰é’®
    â†“
è·å–ç‚¹å‡»åæ ‡ (x, y)
    â†“
è°ƒç”¨ setMode(newMode, x, y)
    â†“
åˆ›å»ºå…¨å±åè½¬é®ç½© (.theme-ripple-overlay)
    â†“
åº”ç”¨ filter: invert(1) + clip-path: circle(0px at x, y)
    â†“
æ·»åŠ åˆ° document.body
    â†“
[0ms] åè½¬åŒºåŸŸ: 0px åœ†ï¼ˆä»ç‚¹å‡»ä½ç½®å¼€å§‹ï¼‰
    â†“
è§¦å‘ CSS transition (clip-path)
    â†“
[1-600ms] åè½¬åœ†å½¢é€æ¸æ‰©æ•£åˆ°å…¨å±
    â†“
[600ms] æ‰©æ•£å®Œæˆ
    â”œâ”€ åˆ‡æ¢ä¸»é¢˜ç±»å (.dark-theme)
    â””â”€ ç§»é™¤é®ç½©
    â†“
å®Œæˆ âœ… (æ— ç¼åˆ‡æ¢ï¼Œæ— é¢œè‰²é—ªçƒ)
```

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```typescript
import { useTheme } from 'contexts/ThemeContext';

function ThemeToggle() {
  const { effective, setMode } = useTheme();

  const handleClick = (event: React.MouseEvent) => {
    const x = event.clientX;
    const y = event.clientY;
    setMode(effective === 'light' ? 'dark' : 'light', x, y);
  };

  return <button onClick={handleClick}>åˆ‡æ¢ä¸»é¢˜</button>;
}
```

### è‡ªå®šä¹‰ä½ç½®

```typescript
// ä»å±å¹•ä¸­å¿ƒæ‰©æ•£
const centerX = window.innerWidth / 2;
const centerY = window.innerHeight / 2;
setMode('dark', centerX, centerY);

// ä»ç‰¹å®šå…ƒç´ æ‰©æ•£
const rect = element.getBoundingClientRect();
const x = rect.left + rect.width / 2;
const y = rect.top + rect.height / 2;
setMode('dark', x, y);
```

## âš¡ æ€§èƒ½æŒ‡æ ‡

- **åŠ¨ç”»å¸§ç‡**: 60 FPSï¼ˆç¡¬ä»¶åŠ é€Ÿï¼‰
- **å†…å­˜å ç”¨**: < 1KBï¼ˆå•ä¸ªå…¨å± divï¼‰
- **CPU å ç”¨**: æä½ï¼ˆCSS `clip-path` ç”± GPU å¤„ç†ï¼‰
- **GPU åŠ é€Ÿ**: âœ…ï¼ˆ`transform: translateZ(0)` + `filter: invert(1)`ï¼‰
- **æ— é—ªçƒ**: âœ…ï¼ˆæ‰©æ•£å®Œæˆåå†åˆ‡æ¢ï¼Œå®Œç¾æ— ç¼ï¼‰

## ğŸ¨ è§†è§‰æ•ˆæœ

### æµ…è‰² â†’ æ·±è‰²

ä»ç‚¹å‡»ä½ç½®å¼€å§‹ï¼Œåœ†å½¢åŒºåŸŸçš„é¢œè‰²è¢«åè½¬ï¼ˆç™½â†’é»‘ï¼Œé»‘â†’ç™½ï¼‰ï¼Œéšç€åœ†å½¢æ‰©æ•£ï¼Œè¶Šæ¥è¶Šå¤šçš„åŒºåŸŸå˜æˆæ·±è‰²ï¼Œæœ€ç»ˆè¦†ç›–å…¨å±ï¼Œè§†è§‰ä¸Šåƒ"é»‘å¤œä»ä¸€ç‚¹é™ä¸´"ã€‚

### æ·±è‰² â†’ æµ…è‰²

ä»ç‚¹å‡»ä½ç½®å¼€å§‹ï¼Œåœ†å½¢åŒºåŸŸçš„é¢œè‰²è¢«åè½¬ï¼ˆé»‘â†’ç™½ï¼Œç™½â†’é»‘ï¼‰ï¼Œéšç€åœ†å½¢æ‰©æ•£ï¼Œè¶Šæ¥è¶Šå¤šçš„åŒºåŸŸå˜æˆæµ…è‰²ï¼Œæœ€ç»ˆè¦†ç›–å…¨å±ï¼Œè§†è§‰ä¸Šåƒ"æ—¥å‡ºä»ä¸€ç‚¹ç ´æ™“"ã€‚

### å…³é”®ä¼˜åŠ¿

- âœ… **æ— ç¼åˆ‡æ¢**ï¼šæ‰©æ•£åŒºåŸŸçš„é¢œè‰²å§‹ç»ˆä¸ç›®æ ‡ä¸»é¢˜ä¸€è‡´
- âœ… **æ— é¢œè‰²è·³å˜**ï¼šä¸ä¼šå‡ºç°æ‰©æ•£ä¸­é€”é¢œè‰²çªå˜çš„é—®é¢˜
- âœ… **è‡ªç„¶è¿‡æ¸¡**ï¼šå°±åƒçœŸå®çš„å…‰å½±ä»ä¸€ç‚¹æ‰©æ•£å¼€æ¥

## ğŸ”§ è‡ªå®šä¹‰é€‰é¡¹

å¦‚éœ€è°ƒæ•´åŠ¨ç”»æ•ˆæœï¼Œå¯ä¿®æ”¹ä»¥ä¸‹å‚æ•°ï¼š

```typescript
// ThemeContext.tsx (åœ¨å‡½æ•°å†…éƒ¨è°ƒæ•´)
const ANIMATION_DURATION = 600; // æ€»æ—¶é•¿
const EASING = 'cubic-bezier(0.4, 0, 0.2, 1)'; // ç¼“åŠ¨å‡½æ•°

// åœ¨ setTimeout ä¸­è°ƒæ•´å»¶è¿Ÿ
setTimeout(() => {
  // åˆ‡æ¢ä¸»é¢˜å¹¶ç§»é™¤é®ç½©
}, ANIMATION_DURATION); // 600ms ååˆ‡æ¢
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **åæ ‡å¿…é¡»æ˜¯å¯é€‰çš„**: æ”¯æŒæ— åŠ¨ç”»åˆ‡æ¢ï¼ˆå¦‚ç³»ç»Ÿä¸»é¢˜å˜åŒ–ï¼‰
2. **ä½¿ç”¨ clientX/Y**: è€Œä¸æ˜¯ pageX/Yï¼Œç¡®ä¿ç›¸å¯¹äºè§†å£å®šä½
3. **åŠæ—¶æ¸…ç†**: åŠ¨ç”»å®Œæˆåå¿…é¡»ç§»é™¤ DOM å…ƒç´ 
4. **é˜²æ­¢é‡å¤**: åˆ‡æ¢è¿‡ç¨‹ä¸­ç¦ç”¨æŒ‰é’®æˆ–å¿½ç•¥åç»­ç‚¹å‡»

## ğŸš€ æœªæ¥æ‰©å±•

å¯ä»¥è€ƒè™‘çš„å¢å¼ºåŠŸèƒ½ï¼š

- [ ] æ·»åŠ åŠ¨ç”»é€Ÿåº¦é…ç½®
- [ ] æ”¯æŒä¸åŒçš„æ‰©æ•£å½¢çŠ¶ï¼ˆæ–¹å½¢ã€è±å½¢ç­‰ï¼‰
- [ ] æ·»åŠ éŸ³æ•ˆåé¦ˆ
- [ ] æ”¯æŒå¤šä¸»é¢˜åˆ‡æ¢ï¼ˆä¸ä»…æ˜¯æ˜æš—ï¼‰
- [ ] æ·»åŠ è¿‡æ¸¡åŠ¨ç”»çš„å¯è®¿é—®æ€§é€‰é¡¹ï¼ˆprefers-reduced-motionï¼‰

## âœ… æ€»ç»“

é€šè¿‡ç»“åˆ React äº‹ä»¶ç³»ç»Ÿã€CSS è¿‡æ¸¡åŠ¨ç”»å’Œ DOM æ“ä½œï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªä¼˜é›…ã€é«˜æ€§èƒ½çš„ä¸»é¢˜åˆ‡æ¢æ‰©æ•£åŠ¨ç”»ã€‚è¿™ä¸ªåŠ¨ç”»ä¸ä»…æå‡äº†ç”¨æˆ·ä½“éªŒï¼Œè¿˜å±•ç¤ºäº†ç°ä»£ Web æŠ€æœ¯çš„å¼ºå¤§èƒ½åŠ›ã€‚

---

**å®ç°å®Œæˆæ—¶é—´**: 2025-10-28
**ç›¸å…³æ–‡ä»¶**:

- `src/contexts/ThemeContext.tsx`
- `src/components/Layout/Header.tsx`
- `src/styles/global.less`
